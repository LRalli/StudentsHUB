<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script async defer src="https://apis.google.com/js/api.js" ></script>
    <script async defer src="https://accounts.google.com/gsi/client" ></script>

    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <link rel="stylesheet" href="./css/drive.css" />

    <title>Drive</title>
    </head>

    <body>

        <!--==========Navbar==========-->
        <nav>
            <!--=====Logo=====-->
            <div class="logo">
            <a href="/">
                <img src="./img/finalHomeB.png" class="logo" height="120px" />
            </a>
            </div>
            <!--=====Btn Toggle Responsive=====-->
            <input type="checkbox" id="click" />
            <label for="click" class="menu-btn">
            <i class="fas fa-bars"></i>
            </label>
            <!--=====Schede=====-->
            <ul id="navbar">
            <li><a href="/">Home</a></li>
            <li><a href="./appartamenti">Appartamenti</a></li>
            <li><a href="./libri">Libri</a></li>
            <li><a href="./corsi">Corsi</a></li>
            <!--=====Login Button=====-->
            <a href="./user" class="btn btn-lg" id="UserButton"
                ><i class="fas fa-user-circle"></i
            ></a>
            </ul>
        </nav>
        <!--==========Fine Navbar==========-->



        <div id="cartella-esistente">
            <p>La cartella è presente nel tuo google drive</p>
            <button onclick="Close1()">Ok</button>
        </div>
        <div id="crea-cartella">
            <p>La cartella non è presente nel tuo google drive. Vuoi crearla?</p>
            <button onclick="CreateFolder()">Si</button>
            <button onclick="Close2()">No</button>
        </div>
        <div class="header">
            <div class="title">Inserisci File in Google Drive</div>
            <div class="auth-buttons">
                <button class="signin">Sign In</button>
                <button class="signout">Sign Out</button>
            </div>
        </div>
        
        <div id="cerca-cartella">
            <input id="cartella" type="text" size="30" maxlength="30" placeholder="Cerca la tua cartella">
            <button onclick="checkFolder()">Cerca</button>
        </div>
        
        <div id="compila">

            <div>
                    <p>Titolo file:</p>

                    <input id="titolo" type="text" size="30" maxlength="30" required>

            </div>

            <div>
                <p>Descrizione file:</p>

                <textarea id="descrizione" cols="50" rows="10" required></textarea>

            </div>

            <button onclick="upload()">Aggiungi file al drive</button>

        </div>

        <!-- Footer -->
        <footer class="text-center text-white" style="background-color: forestgreen">
            <br />
            <p>© 2022 Copyright: <a class="text-white" href="#">StudentsHUB</a></p>
            <p style="font-size: 0.8em; font-weight: bold; padding-left: 10px">
            Made with ❤️ by Lorenzo, Roberto e Ersi
            </p>
            <br />
        </footer>
        <!-- Footer -->
    
    <script>

        window.onload=handleClientLoad;

        var CLIENT_ID = "760521937389-ij66th8q3mqq42802kfal6fjaf2h5164.apps.googleusercontent.com";
        var API_KEY = "AIzaSyBe4AmD0xb5b_T2c6axCLJ54ULp43zBDhs";
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        var SCOPES = "https://www.googleapis.com/auth/drive";
        var signinButton=document.getElementsByClassName('signin')[0];
        var signoutButton=document.getElementsByClassName('signout')[0];
        
        
        function handleClientLoad() {
                gapi.load('client:auth2', initClient)
                console.log('loaded client')
        }
        
        function initClient(){
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES,
                plugin_name:'App Name that you used in google developer console API'
            }).then(function(){
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                signinButton.onclick=handleSignin;
                signoutButton.onclick=handleSignout;
            }, function(error){
                console.log(error);
            })
        }

        function updateSigninStatus(isSignedIn){
            if(isSignedIn){
                signinButton.style.display="none";
                signoutButton.style.display="block";
                document.getElementById("cerca-cartella").style.display = "block";
                document.getElementsByClassName("header")[0].style.marginBottom = "0%";
            }
            else{
                signinButton.style.display="block";
                signoutButton.style.display="none";
                document.getElementById("cerca-cartella").style.display = "none";
                document.getElementsByClassName("header")[0].style.marginBottom = "25%";
            }
        }

        function handleSignin(){
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignout(){
            var auth2=gapi.auth2.getAuthInstance();
            auth2.signOut().then(function(){
                location.reload();
            });
            auth2.disconnect();
        }

        function checkFolder(){
            let folder = document.getElementById("cartella").value;
            console.log(folder);
            let f= '"' + folder + '"';
            console.log(f);
            gapi.client.drive.files.list({
                q: 'name =' + f
            }).then(function(response){
                var files=response.result.files;
                console.log(files)
                if(files && files.length>0){
                    for(var i=0; i<files.length; i++){
                        var file=files[i];
                        localStorage.setItem('parent_folder', file.id);
                        console.log("Cartella disponibile");
                        document.getElementById("cartella-esistente").style.display = "block";
                    }
                }
                else{
                    console.log("Cartella non disponibile");
                    document.getElementById("crea-cartella").style.display = "block";
                }
            })
        }

        function Close1(){
            document.getElementById("cartella-esistente").style.display = "none";
            document.getElementById("compila").style.display = "block";
            document.getElementById("cerca-cartella").style.marginBottom = "0%";
        }

        function Close2(){
            document.getElementById("crea-cartella").style.display = "none";
        }

        function upload(){
            let title = document.getElementById("titolo").value;
            console.log(title);
            let description = document.getElementById("descrizione").value;
            console.log(description);
            let folder = document.getElementById("cartella").value;

            if(description!="" && title !="" && folder!=""){
                const blob= new Blob([description], {type: 'plain/text'});
                const parentFolder=localStorage.getItem('parent_folder');
                var metadata={
                    name: title + '.txt',
                    mimeType: 'plain/text',
                    parents: [parentFolder]
                };
                var formData=new FormData();
                formData.append("metadata", new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                formData.append("file", blob);
                fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                    method: 'POST',
                    headers: new Headers({"Authorization": "Bearer " + gapi.auth.getToken().access_token}),
                    body: formData
                }).then(function(response){
                    return response.json();
                }).then(function(value){
                    console.log(value)
                });         

            }  
        }

        function CreateFolder(){
            var access_token=gapi.auth.getToken().access_token;
            let folder = document.getElementById("cartella").value;
            /*
            var request=gapi.client.request({
                'path': 'drive/v2/files',
                'method': 'POST',
                'headers': {
                    'Content-Type': 'application-json',
                    'Authorization': 'Bearer ' + access_token,
                },
                'body': {
                    'title': 'Pippo',
                    'mimeType': 'application/vnd.google-apps.folder'
                }
            });
            request.execute(function(response){
                console.log(response);
                localStorage.setItem('parent_folder', response.id);
            })
            */

            
            let createFolderOptions = {
                method: "POST",
                headers: {
                    Authorization: `Bearer `+ access_token,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    mimeType: "application/vnd.google-apps.folder",
                    name: folder
                }),
            };

            const response = fetch("https://www.googleapis.com/drive/v3/files", createFolderOptions);
            window.location.href= "http://localhost:8080/drive";
            
        }
        
        /*
                gapi.client.load('drive', 'v3', () => console.log('bam!'))

                let title = document.getElementById("titolo").value
                console.log(title);
                let description = document.getElementById("descrizione").value;
                console.log(description);
        
                gapi.auth2.getAuthInstance().signIn().then(() => {
        
                    console.log('Sign in done');
  
        
                })
        */
        
        
        </script>  
    
    </body>
</html>